<!DOCTYPE html>
<html>
    <head>
        <title>My Account</title>
        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="style/general.css">
        <link rel="stylesheet" type="text/css" href="style/style.css">
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <script type="text/javascript"  src='script/general.js'></script>
        <script type="text/javascript"  src='script/cars.js'></script>
        <script id="rented-car-template" type="text/html">

        <table>
            <tr>
                <th>Picture</th><th>Detail</th><th></th>
            </tr>
            {{#block rented_car}}
            <tr>
                <td><img src="{{picture}}"></td> 
                <td class="car_details"> 
                    <div class="car_title">
                        <div class="car_make">
                            {{make}} | {{model}}
                        </div>
                        <div class="car_year">
                            {{year}}
                        </div>
                    </div>
                    <div class="car_size">
                        Size: {{size}}
                    </div>
                    <div class="rental_ID">
                        Rental #: {{rental_ID}}
                    </div>   
                    <div class="car_date">
                        Rent date: {{rent_date}}
                    </div>          
                </td>
                <td>
                    <div class="return_car" data-rental-id="{{rental_ID}}">Return Car</div>
                </td>

            </tr>
            {{#end block rented_car}}
        </table>
    </script>
    <script id="returned-car-template" type="text/html">
        <table>
            <tr>
                <th>Picture</th><th>Detail</th>
            </tr>
            {{#block returned_car}}
            <tr>
                <td><img src="{{picture}}"></td> 
                <td class="car_details"> 
                    <div class="car_title">
                        <div class="car_make">
                            {{make}} | {{model}}
                        </div>
                        <div class="car_year">
                            {{year}}
                        </div>
                    </div>
                    <div class="car_size">
                        Size: {{size}}
                    </div>
                    <div class="rental_ID">
                        Rental #: {{rental_ID}}
                    </div>   
                    <div class="car_date">
                        Return date: {{return_date}}
                    </div>          
                </td>
            </tr>
            {{#end block returned_car}}
        </table>
    </script>
    <script id="find-car-template" type="text/html">
        <div class='search_item'>
            <img src="{{picture}}">
            <div class='car_make_background'>
                <div class='car_make'>{{make}}</div>
                <div class='car_model'>{{model}} | {{year}}</div> 
            </div>
            <div class='car_color'> Color: <div class='{{color}}'></div></div>
            <div class='car_size'> Size: {{size}}</div>
            <div class='car_rent' id='{{ID}}'> Rent Car </div> 
        </div>
    </script>
</head>
<body>
    <div class="container">

        <div class="account">
            <div class="welcome">

                <a id="logout-link">Logout</a>
                <a href="" id="username"></a> 
                <img id="user_loading" class="user_loading_hidden" src="images/loading.gif">
            </div>

            <img src="images/car.PNG">
            <p>Rent a Car!</p>

        </div>
        <div  class="tabs" id="tabs">
            <div class="tab_pressed"> Find Car
                <div class="tab_detail"> 
                    <div class="search_bar">
                        <form id="search-input"><input name="searchfor" id="find-car-input" placeholder="Type car make, model, year, color, etc."  class="search_field" type="text"><div id="find-car" class="search_button"><img src="images/glass.png"></div></form>

                    </div>
                    <div id="search_results">
                    </div>
                </div>
            </div>
            <input id="#hidden-input" hidden name="hidden-input"/>
            <div class="tab"> Rented Cars
                <div class="tab_detail_hidden"> 
                    <div id="rented_cars">
                    </div>
                </div>
            </div>
            <div class="tab"> Returned Cars
                <div class="tab_detail_hidden"> 
                    <div id="returned_cars">
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
<script>


    //Function responsible of returning car
    //AND updating rental records.
    function return_car(rental_id){

        $.ajax({

            type: 'POST',
            url: 'server/controller.php',
            data: { request_type: "return_car", rental_id: rental_id},

            success: function (response) {


                if (response != "failure") {
                    console.log(response);
                    show_rented_cars();
                    show_returned_cars();

                }
            }
        });
    }


    function show_rented_cars(){

        $.ajax({

            method: 'POST',
            dataType: "json",
            url: 'server/controller.php',
            data: {request_type:"rented_cars"}  ,

            success: function (response){



                if (response != "failure") {
                    console.log(response);
                    var info_template=$("#rented-car-template").html();//get the info-template
                    var html_maker=new htmlMaker(info_template);
                    var html=html_maker.getHTML(response);//generate dynamic HTML for student-info
                    $("#rented_cars").html(html);//show the student info in the info div
                    $(".return_car").on("click", function(){
                       //ARGUMENT: THE ID of clicked button which is rental-id
                        return_car($(this).attr("data-rental-id"));

                    });
                }
            }
        });

    }

    function show_returned_cars(){
        $.ajax({

            type: 'POST',
            url: 'server/controller.php',
            dataType: 'json',
            data: "request_type=show_returned_cars",

            success: function (response) {

                 console.log(response);
                if (response != "failure") {
                    var info_template=$("#returned-car-template").html();//get the info-template
                    var html_maker=new htmlMaker(info_template);
                    var html=html_maker.getHTML(response);//generate dynamic HTML for student-info
                    $("#returned_cars").html(html);//show the student info in the info div

                }
            }
            });
    }

    /**
     * FUNCTION DISPLAY CARS ACCORDING TO
     * SEARCH BAR
     *
     */

    function rent_car(curr_car_id){

        //process rent car php
        var car_id = curr_car_id;
        //use hidden element to set the car_id
        $("#hidden-input").val(car_id);
        //send ajax request
        var data_2 = "hidden-input="+car_id;
        console.log(data_2);
        $.ajax({

            type: 'POST',
            url: 'rentacar.php',
            data: data_2,

            success: function (response) {

                console.log(response);
                if (response != "failure") {

                    alert("done");
                    //Showing rest of results with the same search input!
                    //All cars will stay but the rented car!
                    var data = $("#search-input").serialize();
                    display_search_for_car(data);
                    show_rented_cars();

                }
            }
        });

    }


    function display_search_for_car(data){
        data+='&request_type=car_search';
        $.ajax({

            type: 'POST',
            url: 'server/controller.php',
            dataType: 'json',
            data: data,


            success: function (response) {
                console.log(data);
                response = response.search_results;

                if (response != "failure") {


                    var info_template=$("#find-car-template").html();//get the info-template
                    var html_maker=new htmlMaker(info_template);
                    var html=html_maker.getHTML(response);//generate dynamic HTML for student-info
                    $("#search_results").html(html);//show the student info in the info div

                    $(".car_rent").on("click", function(){

                        var curr = $(this).attr("id")
                        alert(curr);
                        rent_car(curr);
                    });

                } else {
                    alert("failure");
                }
            }
        });


    }
    $(document).ready(function() {

        show_rented_cars();
        show_returned_cars();
        $("#find-car").on("click", function(){
            var data = $("#search-input").serialize();

            display_search_for_car(data);
        });

        });
</script>
</html>